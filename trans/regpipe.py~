import pandas as pd
import numpy as np

from sklearn.pipeline import Pipeline, make_pipeline
from datetime import timedelta

import re

from trans.gtrans import *
from trans.reg import Reg

idx = pd.IndexSlice

class RegPipe:
    """
    TO DO:
    reg.sensAttrs:  
       assumes data in self.data; make it take df as arg ?
       assumes betas in same df as data, that's why sensAttrs needs to serve

    depTickersFromSensAttrs(sensAttrs ):
       assumes data in self.data; make it take df as arg ?
          that's why needs to search for non-sens as dependent

    reg.retAttrib:
       assumes sensitivities, indVars and depVars are all in same df
        reg is ret_and_rolled_beta_df


    - 
    """
    
    def __init__(self, df, debug=False):
        self.df = df
        self.debug = debug

        self.reg = Reg(df)


    def indCol(self, col):
        self.indCol = col
        

    def addConst():
        """
        Add constant column (needed only for attribution, not regression)
        """

        self.reg.addConst(("Pct", "1"), 1)
        
        
    def regress(self, start, end, window, step):
        reg = self.reg
        indCol = self.indCol
        
        ma = reg.modelCols( [ indCol ])

        beta_df = reg.rollingModelAll( *ma, 
                                       start, end,
                                       step
                                       )

        self.beta_df = beta_df

 
    def rollBeta(self):
        beta_df = self.beta_df

        rab = Reg(beta_df)

        beta_r_pl = make_pipeline( ShiftTransformer(1),
                                   FillNullTransformer(method="ffill"),
                         )
        
        beta_rolled_df = beta_r_pl.fit_transform(beta_df)

        self.beta_rolled_df = beta_rolled_df
        

    def attrib(self):
        reg = self.reg
        df  = reg.data

        beta_df = self.beta_rolled_df

    
        indCols = [ ("Pct", "1"), self.indCol ]

        sensAttrs = beta_df.columns.get_level_values(0).unique().tolist()

        regBeta = Reg(beta_df)

        depTickers = regBeta.depTickersFromSensAttrs(sensAttrs )
        depCols = [ ("Pct", t) for t in depTickers ]

        reg.addConst(("Pct", "1"), 1)

        # TO DO: assumes the df in reg contains both dependents/independents (indCols, depCols) AND sensitivities in same df
        retAttr_df =reg.retAttrib(
            indCols,
            depCols, 
            sensAttrs)

        self.retAttr_df = retAttr_df

        
        

        
